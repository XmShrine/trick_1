<!DOCTYPE html>

<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>像素风音游</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

    body {
        background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
        font-family: 'Courier New', monospace;
        overflow: hidden;
        height: 100vh;
        display: flex;
        flex-direction: column;
    }

    #gameContainer {
        flex: 1;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    #gameArea {
        flex: 1;
        position: relative;
        overflow: hidden;
        border: 3px solid #00ff88;
        border-radius: 8px;
        margin: 10px;
        background: 
            radial-gradient(circle at 25% 25%, rgba(0, 255, 136, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 75% 75%, rgba(0, 136, 255, 0.1) 0%, transparent 50%),
            linear-gradient(180deg, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.95) 100%);
    }

    #scoreBoard {
        background: rgba(0, 0, 0, 0.8);
        color: #00ff88;
        padding: 10px;
        font-size: 16px;
        font-weight: bold;
        text-align: center;
        border-bottom: 2px solid #00ff88;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #controlArea {
        height: 100px;
        background: rgba(0, 0, 0, 0.9);
        border-top: 3px solid #00ff88;
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding: 10px;
    }

    .hitZone {
        width: 80px;
        height: 80px;
        border: 3px solid #00ff88;
        border-radius: 8px;
        background: rgba(0, 255, 136, 0.1);
        position: relative;
        cursor: pointer;
        transition: all 0.1s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: #00ff88;
        font-weight: bold;
        box-shadow: 
            inset 0 0 10px rgba(0, 255, 136, 0.3),
            0 0 20px rgba(0, 255, 136, 0.2);
    }

    .hitZone:active, .hitZone.active {
        background: rgba(0, 255, 136, 0.4);
        transform: scale(0.95);
        box-shadow: 
            inset 0 0 20px rgba(0, 255, 136, 0.6),
            0 0 30px rgba(0, 255, 136, 0.4);
    }

    .note {
        position: absolute;
        width: 74px;
        height: 74px;
        border-radius: 6px;
        border: 2px solid #ff6b6b;
        background: 
            linear-gradient(45deg, #ff6b6b, #ff8e8e),
            url('source.jpeg');
        background-size: cover, 100% 100%;
        background-position: center, center;
        background-blend-mode: multiply;
        box-shadow: 
            0 4px 8px rgba(255, 107, 107, 0.4),
            inset 0 0 10px rgba(255, 255, 255, 0.2);
        animation: fall linear;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: white;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }

    .note::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, 
            transparent 25%, rgba(255, 255, 255, 0.1) 25%,
            rgba(255, 255, 255, 0.1) 50%, transparent 50%,
            transparent 75%, rgba(255, 255, 255, 0.1) 75%);
        background-size: 8px 8px;
        border-radius: 8px;
        z-index: -1;
    }

    @keyframes fall {
        from {
            transform: translateY(-100px);
        }
        to {
            transform: translateY(calc(100vh - 100px));
        }
    }

    .perfect, .good, .miss {
        position: absolute;
        font-size: 24px;
        font-weight: bold;
        pointer-events: none;
        animation: scorePopup 1s ease-out forwards;
    }

    .perfect { color: #00ff88; }
    .good { color: #ffaa00; }
    .miss { color: #ff4444; }

    @keyframes scorePopup {
        0% {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        100% {
            opacity: 0;
            transform: translateY(-50px) scale(1.2);
        }
    }

    #startButton {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(45deg, #00ff88, #00cc6a);
        color: white;
        border: none;
        padding: 20px 40px;
        font-size: 24px;
        font-weight: bold;
        border-radius: 12px;
        cursor: pointer;
        font-family: 'Courier New', monospace;
        box-shadow: 
            0 6px 20px rgba(0, 255, 136, 0.4),
            inset 0 0 20px rgba(255, 255, 255, 0.1);
        transition: all 0.2s ease;
    }

    #startButton:hover {
        transform: translate(-50%, -50%) scale(1.05);
        box-shadow: 
            0 8px 25px rgba(0, 255, 136, 0.6),
            inset 0 0 25px rgba(255, 255, 255, 0.2);
    }

    #startButton:active {
        transform: translate(-50%, -50%) scale(0.98);
    }

    .combo {
        position: absolute;
        top: 20px;
        right: 20px;
        color: #ffaa00;
        font-size: 20px;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }

    #gameEndScreen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .results-container {
        background: 
            linear-gradient(135deg, 
                rgba(0, 255, 136, 0.15) 0%, 
                rgba(0, 136, 255, 0.15) 50%,
                rgba(255, 107, 107, 0.15) 100%
            );
        border: 4px solid #00ff88;
        border-radius: 16px;
        padding: 30px;
        text-align: center;
        box-shadow: 
            0 0 40px rgba(0, 255, 136, 0.3),
            inset 0 0 20px rgba(255, 255, 255, 0.1);
        max-width: 400px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .results-title {
        font-size: 32px;
        color: #00ff88;
        font-weight: bold;
        margin-bottom: 20px;
        text-shadow: 
            2px 2px 0px #004400,
            0 0 20px rgba(0, 255, 136, 0.8);
        letter-spacing: 2px;
    }

    .results-score {
        font-size: 48px;
        color: #ffffff;
        font-weight: bold;
        margin: 20px 0;
        text-shadow: 
            3px 3px 0px #333333,
            0 0 30px rgba(255, 255, 255, 0.8);
        background: linear-gradient(45deg, #ffffff, #00ff88);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .results-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin: 25px 0;
    }

    .stat-item {
        background: rgba(0, 0, 0, 0.6);
        border: 2px solid;
        border-radius: 8px;
        padding: 12px;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }

    .stat-perfect {
        border-color: #00ff88;
        color: #00ff88;
        box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
    }

    .stat-good {
        border-color: #ffaa00;
        color: #ffaa00;
        box-shadow: 0 0 15px rgba(255, 170, 0, 0.3);
    }

    .stat-miss {
        border-color: #ff4444;
        color: #ff4444;
        box-shadow: 0 0 15px rgba(255, 68, 68, 0.3);
    }

    .stat-combo {
        border-color: #8844ff;
        color: #8844ff;
        box-shadow: 0 0 15px rgba(136, 68, 255, 0.3);
        grid-column: 1 / -1;
    }

    .restart-button {
        background: linear-gradient(45deg, #00ff88, #00cc6a);
        color: white;
        border: 3px solid #00ff88;
        padding: 15px 35px;
        font-size: 20px;
        font-weight: bold;
        border-radius: 12px;
        cursor: pointer;
        font-family: 'Courier New', monospace;
        margin-top: 20px;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 
            0 6px 20px rgba(0, 255, 136, 0.4),
            inset 0 0 20px rgba(255, 255, 255, 0.1);
    }

    .restart-button:hover {
        transform: scale(1.05);
        background: linear-gradient(45deg, #00cc6a, #00aa55);
        box-shadow: 
            0 8px 25px rgba(0, 255, 136, 0.6),
            inset 0 0 25px rgba(255, 255, 255, 0.2);
    }

    .restart-button:active {
        transform: scale(0.98);
    }

    .accuracy-bar {
        width: 100%;
        height: 8px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 4px;
        margin: 15px 0;
        overflow: hidden;
        border: 1px solid #333;
    }

    .accuracy-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff4444, #ffaa00, #00ff88);
        border-radius: 3px;
        transition: width 1s ease-out;
        box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
    }

    .rank-display {
        font-size: 24px;
        font-weight: bold;
        margin: 10px 0;
        padding: 8px 16px;
        border-radius: 8px;
        display: inline-block;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .rank-s { 
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        color: #333;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
    }
    .rank-a { 
        background: linear-gradient(45deg, #00ff88, #00cc6a);
        color: white;
        box-shadow: 0 0 20px rgba(0, 255, 136, 0.6);
    }
    .rank-b { 
        background: linear-gradient(45deg, #0088ff, #0066cc);
        color: white;
        box-shadow: 0 0 20px rgba(0, 136, 255, 0.6);
    }
    .rank-c { 
        background: linear-gradient(45deg, #ffaa00, #ff8800);
        color: white;
        box-shadow: 0 0 20px rgba(255, 170, 0, 0.6);
    }
    .rank-d { 
        background: linear-gradient(45deg, #ff4444, #cc3333);
        color: white;
        box-shadow: 0 0 20px rgba(255, 68, 68, 0.6);
    }

    /* 手机适配 */
    @media (max-width: 768px) {
        #scoreBoard {
            font-size: 14px;
            padding: 8px;
        }
        
        .hitZone {
            width: 70px;
            height: 70px;
            font-size: 20px;
        }
        
        .note {
            width: 64px;
            height: 64px;
            font-size: 16px;
        }
        
        #controlArea {
            height: 90px;
            padding: 8px;
        }
        
        #startButton {
            padding: 15px 30px;
            font-size: 20px;
        }
        
        .perfect, .good, .miss {
            font-size: 20px;
        }
        
        .combo {
            font-size: 18px;
            top: 15px;
            right: 15px;
        }
    }

    @media (max-width: 480px) {
        .hitZone {
            width: 60px;
            height: 60px;
            font-size: 18px;
        }
        
        .note {
            width: 54px;
            height: 54px;
            font-size: 14px;
        }
        
        #controlArea {
            height: 80px;
        }
        
        #startButton {
            padding: 12px 24px;
            font-size: 18px;
        }
        
        .results-container {
            padding: 20px;
            max-width: 350px;
        }
        
        .results-title {
            font-size: 24px;
        }
        
        .results-score {
            font-size: 36px;
        }
        
        .restart-button {
            padding: 12px 25px;
            font-size: 16px;
        }
    }
</style>

</head>
<body>
    <div id="gameContainer">
        <div id="scoreBoard">
            <div>Score: <span id="score">0</span></div>
            <div>Perfect: <span id="perfect">0</span> | Good: <span id="good">0</span> | Miss: <span id="miss">0</span></div>
        </div>

    <div id="gameArea">
        <div class="combo" id="combo" style="display: none;">Combo: 0</div>
        <button id="startButton">开始游戏</button>
        
        <div id="gameEndScreen">
            <div class="results-container">
                <div class="results-title">GAME OVER</div>
                <div class="rank-display" id="rankDisplay">RANK A</div>
                <div class="results-score" id="finalScore">0</div>
                
                <div class="accuracy-bar">
                    <div class="accuracy-fill" id="accuracyFill"></div>
                </div>
                <div style="color: #ccc; font-size: 14px; margin-bottom: 15px;">
                    Accuracy: <span id="accuracyText">0%</span>
                </div>
                
                <div class="results-stats">
                    <div class="stat-item stat-perfect">
                        <div style="font-size: 12px;">PERFECT</div>
                        <div style="font-size: 18px;" id="finalPerfect">0</div>
                    </div>
                    <div class="stat-item stat-good">
                        <div style="font-size: 12px;">GOOD</div>
                        <div style="font-size: 18px;" id="finalGood">0</div>
                    </div>
                    <div class="stat-item stat-miss">
                        <div style="font-size: 12px;">MISS</div>
                        <div style="font-size: 18px;" id="finalMiss">0</div>
                    </div>
                    <div class="stat-item stat-combo">
                        <div style="font-size: 12px;">MAX COMBO</div>
                        <div style="font-size: 18px;" id="finalCombo">0</div>
                    </div>
                </div>
                
                <button class="restart-button" onclick="restartGame()">PLAY AGAIN</button>
            </div>
        </div>
    </div>
    
    <div id="controlArea">
        <div class="hitZone" data-lane="0">D</div>
        <div class="hitZone" data-lane="1">F</div>
        <div class="hitZone" data-lane="2">J</div>
        <div class="hitZone" data-lane="3">K</div>
    </div>
</div>

<audio id="bgMusic" preload="auto">
    <source src="audio.mp3" type="audio/mpeg">
</audio>

<audio id="hitSound" preload="auto">
    <source src="push.m4a" type="audio/mp4">
</audio>

<script>
    // 游戏配置
    const pushTime = [
        // 示例节拍时间（毫秒），你可以根据音乐调整
        5000, 7900, 10000, 11000
    ];

    // 游戏状态
    let gameState = {
        isPlaying: false,
        startTime: 0,
        score: 0,
        perfect: 0,
        good: 0,
        miss: 0,
        combo: 0,
        maxCombo: 0,
        notes: []
    };

    // DOM 元素
    const gameArea = document.getElementById('gameArea');
    const startButton = document.getElementById('startButton');
    const bgMusic = document.getElementById('bgMusic');
    const hitSound = document.getElementById('hitSound');
    const hitZones = document.querySelectorAll('.hitZone');
    
    // 分数显示元素
    const scoreEl = document.getElementById('score');
    const perfectEl = document.getElementById('perfect');
    const goodEl = document.getElementById('good');
    const missEl = document.getElementById('miss');
    const comboEl = document.getElementById('combo');

    // 游戏常量
    const FALL_DURATION = 2000; // 音符下落时间
    const HIT_TOLERANCE = 150; // 击中容忍度

    // 开始游戏
    startButton.addEventListener('click', startGame);

    function startGame() {
        startButton.style.display = 'none';
        comboEl.style.display = 'block';
        gameState.isPlaying = true;
        gameState.startTime = Date.now();
        
        // 重置分数
        resetScore();
        
        // 播放背景音乐
        bgMusic.currentTime = 0;
        bgMusic.play().catch(e => console.log('音频播放失败:', e));
        
        // 生成音符
        generateNotes();
        
        // 开始游戏循环
        gameLoop();
    }

    function generateNotes() {
        pushTime.forEach((time, index) => {
            setTimeout(() => {
                if (gameState.isPlaying) {
                    createNote(Math.floor(Math.random() * 4));
                }
            }, time - FALL_DURATION);
        });
    }

    function createNote(lane) {
        const note = document.createElement('div');
        note.className = 'note';
        note.dataset.lane = lane;
        note.dataset.createTime = Date.now();
        
        // 设置音符位置
        const hitZone = hitZones[lane];
        const rect = hitZone.getBoundingClientRect();
        const gameRect = gameArea.getBoundingClientRect();
        
        note.style.left = (rect.left - gameRect.left + 3) + 'px';
        note.style.animationDuration = FALL_DURATION + 'ms';
        
        gameArea.appendChild(note);
        gameState.notes.push(note);
        
        // 移除超时的音符
        setTimeout(() => {
            if (note.parentNode) {
                note.remove();
                const index = gameState.notes.indexOf(note);
                if (index > -1) {
                    gameState.notes.splice(index, 1);
                    // 超时算miss
                    addScore('miss', lane);
                }
            }
        }, FALL_DURATION + 500);
    }

    function gameLoop() {
        if (!gameState.isPlaying) return;
        
        // 检查游戏结束条件
        const currentTime = Date.now() - gameState.startTime;
        if (currentTime > Math.max(...pushTime) + FALL_DURATION + 1000) {
            endGame();
            return;
        }
        
        requestAnimationFrame(gameLoop);
    }

    function endGame() {
        gameState.isPlaying = false;
        bgMusic.pause();
        
        // 显示结算界面
        showGameEndScreen();
    }

    function showGameEndScreen() {
        const gameEndScreen = document.getElementById('gameEndScreen');
        const finalScore = document.getElementById('finalScore');
        const finalPerfect = document.getElementById('finalPerfect');
        const finalGood = document.getElementById('finalGood');
        const finalMiss = document.getElementById('finalMiss');
        const finalCombo = document.getElementById('finalCombo');
        const accuracyFill = document.getElementById('accuracyFill');
        const accuracyText = document.getElementById('accuracyText');
        const rankDisplay = document.getElementById('rankDisplay');

        // 计算准确率
        const totalNotes = gameState.perfect + gameState.good + gameState.miss;
        const accuracy = totalNotes > 0 ? ((gameState.perfect + gameState.good) / totalNotes * 100) : 0;
        
        // 计算等级
        let rank, rankClass;
        if (accuracy >= 95) {
            rank = 'S';
            rankClass = 'rank-s';
        } else if (accuracy >= 85) {
            rank = 'A';
            rankClass = 'rank-a';
        } else if (accuracy >= 75) {
            rank = 'B';
            rankClass = 'rank-b';
        } else if (accuracy >= 60) {
            rank = 'C';
            rankClass = 'rank-c';
        } else {
            rank = 'D';
            rankClass = 'rank-d';
        }

        // 更新显示
        finalScore.textContent = gameState.score.toLocaleString();
        finalPerfect.textContent = gameState.perfect;
        finalGood.textContent = gameState.good;
        finalMiss.textContent = gameState.miss;
        finalCombo.textContent = gameState.maxCombo;
        accuracyText.textContent = accuracy.toFixed(1) + '%';
        rankDisplay.textContent = 'RANK ' + rank;
        rankDisplay.className = 'rank-display ' + rankClass;

        // 显示屏幕
        gameEndScreen.style.display = 'flex';

        // 动画效果
        setTimeout(() => {
            accuracyFill.style.width = accuracy + '%';
        }, 500);
    }

    function restartGame() {
        const gameEndScreen = document.getElementById('gameEndScreen');
        gameEndScreen.style.display = 'none';
        
        // 清理剩余音符
        gameState.notes.forEach(note => note.remove());
        gameState.notes = [];
        
        // 重置状态
        resetScore();
        startButton.style.display = 'block';
        startButton.textContent = '重新开始';
        comboEl.style.display = 'none';
    }

    // 按键处理
    hitZones.forEach((zone, index) => {
        // 鼠标/触摸事件
        zone.addEventListener('mousedown', () => hitLane(index));
        zone.addEventListener('touchstart', (e) => {
            e.preventDefault();
            hitLane(index);
        });
    });

    // 键盘事件
    document.addEventListener('keydown', (e) => {
        if (!gameState.isPlaying) return;
        
        const keyMap = { 'KeyD': 0, 'KeyF': 1, 'KeyJ': 2, 'KeyK': 3 };
        if (keyMap[e.code] !== undefined) {
            e.preventDefault();
            hitLane(keyMap[e.code]);
        }
    });

    function hitLane(lane) {
        if (!gameState.isPlaying) return;
        
        // 视觉反馈
        hitZones[lane].classList.add('active');
        setTimeout(() => hitZones[lane].classList.remove('active'), 100);
        
        // 查找该轨道的音符
        const laneNotes = gameState.notes.filter(note => 
            parseInt(note.dataset.lane) === lane && note.parentNode
        );
        
        if (laneNotes.length === 0) return;
        
        // 找到最接近击中区域的音符
        const hitZoneRect = hitZones[lane].getBoundingClientRect();
        const hitZoneCenter = hitZoneRect.top + hitZoneRect.height / 2;
        
        let closestNote = null;
        let minDistance = Infinity;
        
        laneNotes.forEach(note => {
            const noteRect = note.getBoundingClientRect();
            const noteCenter = noteRect.top + noteRect.height / 2;
            const distance = Math.abs(noteCenter - hitZoneCenter);
            
            if (distance < minDistance && distance < HIT_TOLERANCE) {
                minDistance = distance;
                closestNote = note;
            }
        });
        
        if (closestNote) {
            // 播放击中音效
            hitSound.currentTime = 0;
            hitSound.play().catch(e => console.log('音效播放失败:', e));
            
            // 移除音符
            closestNote.remove();
            const index = gameState.notes.indexOf(closestNote);
            if (index > -1) {
                gameState.notes.splice(index, 1);
            }
            
            // 计算得分
            const scoreType = minDistance < 50 ? 'perfect' : 'good';
            addScore(scoreType, lane);
        }
    }

    function addScore(type, lane) {
        const hitZoneRect = hitZones[lane].getBoundingClientRect();
        const gameRect = gameArea.getBoundingClientRect();
        
        let points = 0;
        let text = '';
        
        switch(type) {
            case 'perfect':
                points = 100;
                text = 'PERFECT!';
                gameState.perfect++;
                gameState.combo++;
                gameState.maxCombo = Math.max(gameState.maxCombo, gameState.combo);
                break;
            case 'good':
                points = 50;
                text = 'GOOD!';
                gameState.good++;
                gameState.combo++;
                gameState.maxCombo = Math.max(gameState.maxCombo, gameState.combo);
                break;
            case 'miss':
                points = 0;
                text = 'MISS!';
                gameState.miss++;
                gameState.combo = 0;
                break;
        }
        
        gameState.score += points;
        updateDisplay();
        
        // 显示得分动画
        const scorePopup = document.createElement('div');
        scorePopup.className = type;
        scorePopup.textContent = text;
        scorePopup.style.left = (hitZoneRect.left - gameRect.left + hitZoneRect.width / 2) + 'px';
        scorePopup.style.top = (hitZoneRect.top - gameRect.top) + 'px';
        
        gameArea.appendChild(scorePopup);
        setTimeout(() => scorePopup.remove(), 1000);
    }

    function updateDisplay() {
        scoreEl.textContent = gameState.score;
        perfectEl.textContent = gameState.perfect;
        goodEl.textContent = gameState.good;
        missEl.textContent = gameState.miss;
        comboEl.textContent = gameState.combo > 0 ? `Combo: ${gameState.combo}` : '';
        comboEl.style.display = gameState.combo > 5 ? 'block' : 'none';
    }

    function resetScore() {
        gameState.score = 0;
        gameState.perfect = 0;
        gameState.good = 0;
        gameState.miss = 0;
        gameState.combo = 0;
        gameState.maxCombo = 0;
        updateDisplay();
    }

    // 防止页面滚动
    document.addEventListener('touchmove', (e) => {
        e.preventDefault();
    }, { passive: false });
    
    // 防止双击缩放
    let lastTouchEnd = 0;
    document.addEventListener('touchend', (e) => {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) {
            e.preventDefault();
        }
        lastTouchEnd = now;
    }, false);
</script>

</body>
</html>